import 'dart:convert';
import 'package:flutter/services.dart';
import 'package:path_provider/path_provider.dart';
import 'package:sqflite/sqflite.dart';
import 'package:http/http.dart' as http;
import '../models/quran_data.dart';
import '../models/surah.dart';
import '../models/ayah.dart';

class QuranDB {
  static final QuranDB _instance = QuranDB._internal();
  factory QuranDB() => _instance;
  QuranDB._internal();

  Database? _database;
  QuranData? _quranData;

  static const String _dbName = 'quran.db';
  static const int _dbVersion = 1;

  // Tables
  static const String _surahsTable = 'surahs';
  static const String _ayahsTable = 'ayahs';
  static const String _favoritesTable = 'favorites';
  static const String _readingHistoryTable = 'reading_history';

  Future<Database> get database async {
    _database ??= await _initDatabase();
    return _database!;
  }

  Future<Database> _initDatabase() async {
    final documentsDirectory = await getApplicationDocumentsDirectory();
    final path = '${documentsDirectory.path}/$_dbName';
    
    return await openDatabase(
      path,
      version: _dbVersion,
      onCreate: _onCreate,
      onUpgrade: _onUpgrade,
    );
  }

  Future<void> _onCreate(Database db, int version) async {
    // Table des sourates
    await db.execute('''
      CREATE TABLE $_surahsTable (
        number INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        english_name TEXT NOT NULL,
        english_name_translation TEXT NOT NULL,
        revelation_type TEXT NOT NULL,
        number_of_ayahs INTEGER NOT NULL
      )
    ''');

    // Table des ayahs
    await db.execute('''
      CREATE TABLE $_ayahsTable (
        number INTEGER PRIMARY KEY,
        text TEXT NOT NULL,
        number_in_surah INTEGER NOT NULL,
        surah_number INTEGER NOT NULL,
        juz INTEGER NOT NULL,
        manzil INTEGER NOT NULL,
        page INTEGER NOT NULL,
        ruku INTEGER NOT NULL,
        hizb_quarter INTEGER NOT NULL,
        sajda INTEGER DEFAULT 0,
        translation TEXT,
        FOREIGN KEY (surah_number) REFERENCES $_surahsTable (number)
      )
    ''');

    // Table des favoris
    await db.execute('''
      CREATE TABLE $_favoritesTable (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        surah_number INTEGER NOT NULL,
        ayah_number INTEGER NOT NULL,
        created_at TEXT NOT NULL,
        UNIQUE(surah_number, ayah_number)
      )
    ''');

    // Table de l'historique de lecture
    await db.execute('''
      CREATE TABLE $_readingHistoryTable (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        surah_number INTEGER NOT NULL,
        ayah_number INTEGER NOT NULL,
        read_at TEXT NOT NULL
      )
    ''');

    // Index pour am√©liorer les performances
    await db.execute('CREATE INDEX idx_ayahs_surah ON $_ayahsTable (surah_number)');
    await db.execute('CREATE INDEX idx_ayahs_text ON $_ayahsTable (text)');
  }

  Future<void> _onUpgrade(Database db, int oldVersion, int newVersion) async {
    // Gestion des migrations futures
  }

  /// Initialise la base de donn√©es avec les donn√©es du Coran
  Future<void> initializeWithQuranData() async {
    final db = await database;
    
    // V√©rifier si les donn√©es existent d√©j√† ET si nous avons les 114 sourates compl√®tes
    final count = Sqflite.firstIntValue(
      await db.rawQuery('SELECT COUNT(*) FROM $_surahsTable')
    ) ?? 0;
    
    if (count == 114) {
      print('‚úÖ Base de donn√©es d√©j√† initialis√©e avec ${count} sourates compl√®tes');
      return;
    }
    
    if (count > 0 && count < 114) {
      print('üîÑ Base de donn√©es incompl√®te (${count}/114 sourates). Mise √† jour...');
      // Supprimer les donn√©es incompl√®tes
      await db.delete(_ayahsTable);
      await db.delete(_surahsTable);
    }

    // Charger les donn√©es compl√®tes depuis l'API
    await _loadQuranDataFromAssets();
  }

  /// Charge les donn√©es du Coran depuis l'API AlQuran.cloud
  Future<void> _loadQuranDataFromAssets() async {
    try {
      print('üåê Chargement du Coran depuis l\'API AlQuran.cloud...');
      
      // Charger le texte arabe du Coran
      final arabicResponse = await http.get(
        Uri.parse('http://api.alquran.cloud/v1/quran/quran-uthmani'),
        headers: {'Accept': 'application/json'},
      );
      
      if (arabicResponse.statusCode != 200) {
        throw Exception('Erreur API: ${arabicResponse.statusCode}');
      }
      
      // Charger la traduction fran√ßaise
      final frenchResponse = await http.get(
        Uri.parse('http://api.alquran.cloud/v1/quran/fr.hamidullah'),
        headers: {'Accept': 'application/json'},
      );
      
      final arabicData = json.decode(arabicResponse.body);
      final frenchData = frenchResponse.statusCode == 200 
          ? json.decode(frenchResponse.body) 
          : null;
      
      await _saveApiDataToDatabase(arabicData, frenchData);
      
    } catch (e) {
      print('‚ùå Erreur lors du chargement depuis l\'API: $e');
      print('üì¶ Tentative de chargement depuis les assets...');
      
      try {
        // Fallback vers les assets locaux
        final String jsonString = await rootBundle.loadString('assets/quran/quran.json');
        final Map<String, dynamic> jsonData = json.decode(jsonString);
        
        final quranData = QuranData.fromJson(jsonData);
        await _saveQuranDataToDatabase(quranData);
        
      } catch (assetError) {
        print('‚ùå Erreur assets: $assetError');
        print('üîß Cr√©ation de donn√©es d\'exemple...');
        await _createSampleData();
      }
    }
  }

  /// Sauvegarde les donn√©es du Coran dans la base de donn√©es
  Future<void> _saveQuranDataToDatabase(QuranData quranData) async {
    final db = await database;
    
    await db.transaction((txn) async {
      // Ins√©rer les sourates
      for (final surah in quranData.surahs) {
        await txn.insert(_surahsTable, {
          'number': surah.number,
          'name': surah.name,
          'english_name': surah.englishName,
          'english_name_translation': surah.englishNameTranslation,
          'revelation_type': surah.revelationType,
          'number_of_ayahs': surah.numberOfAyahs,
        });
        
        // Ins√©rer les ayahs de cette sourate
        for (final ayah in surah.ayahs) {
          await txn.insert(_ayahsTable, {
            'number': ayah.number,
            'text': ayah.text,
            'number_in_surah': ayah.numberInSurah,
            'surah_number': surah.number,
            'juz': ayah.juz,
            'manzil': ayah.manzil,
            'page': ayah.page,
            'ruku': ayah.ruku,
            'hizb_quarter': ayah.hizbQuarter,
            'sajda': ayah.sajda ? 1 : 0,
            'translation': ayah.translation,
          });
        }
      }
    });
    
    print('Donn√©es du Coran sauvegard√©es: ${quranData.surahs.length} sourates');
  }

  /// Sauvegarde les donn√©es de l'API AlQuran.cloud dans la base de donn√©es
  Future<void> _saveApiDataToDatabase(Map<String, dynamic> arabicData, Map<String, dynamic>? frenchData) async {
    final db = await database;
    
    print('üíæ Sauvegarde des donn√©es API dans la base de donn√©es...');
    
    final surahs = arabicData['data']['surahs'] as List;
    final frenchSurahs = frenchData?['data']['surahs'] as List?;
    
    print('üìä Nombre de sourates √† sauvegarder: ${surahs.length}');
    
    await db.transaction((txn) async {
      for (int i = 0; i < surahs.length; i++) {
        final surah = surahs[i];
        final frenchSurah = frenchSurahs != null && i < frenchSurahs.length ? frenchSurahs[i] : null;
        
        // Ins√©rer la sourate
        final ayahs = surah['ayahs'] as List? ?? [];
        final numberOfAyahs = ayahs.length;
        
        print('üìù Sourate ${surah['number']}: ${surah['name']} (${numberOfAyahs} ayahs)');
        
        await txn.insert(_surahsTable, {
          'number': surah['number'],
          'name': surah['name'],
          'english_name': surah['englishName'],
          'english_name_translation': surah['englishNameTranslation'],
          'revelation_type': surah['revelationType'],
          'number_of_ayahs': numberOfAyahs,
        });
        
        // Ins√©rer les ayahs
        final frenchAyahs = frenchSurah?['ayahs'] as List?;
        
        for (int j = 0; j < ayahs.length; j++) {
          final ayah = ayahs[j];
          final frenchAyah = frenchAyahs != null && j < frenchAyahs.length ? frenchAyahs[j] : null;
          
          await txn.insert(_ayahsTable, {
            'number': ayah['number'],
            'text': ayah['text'],
            'number_in_surah': ayah['numberInSurah'],
            'surah_number': surah['number'],
            'juz': ayah['juz'],
            'manzil': ayah['manzil'],
            'page': ayah['page'],
            'ruku': ayah['ruku'],
            'hizb_quarter': ayah['hizbQuarter'],
            'sajda': ayah['sajda'] == true ? 1 : 0,
            'translation': frenchAyah?['text'] ?? 'Traduction non disponible',
          });
        }
      }
    });
    
    print('‚úÖ ${surahs.length} sourates sauvegard√©es depuis l\'API AlQuran.cloud');
  }

  /// Cr√©e des donn√©es compl√®tes du Coran (114 sourates)
  Future<void> _createSampleData() async {
    final db = await database;
    
    print('Cr√©ation des donn√©es compl√®tes du Coran (114 sourates)...');
    
    // Donn√©es des 114 sourates avec leurs informations de base
    final surahsData = [
      [1, 'ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©', 'Al-Fatihah', 'The Opening', 'Meccan', 7],
      [2, 'ÿßŸÑÿ®ŸÇÿ±ÿ©', 'Al-Baqarah', 'The Cow', 'Medinan', 286],
      [3, 'ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ', 'Ali \'Imran', 'Family of Imran', 'Medinan', 200],
      [4, 'ÿßŸÑŸÜÿ≥ÿßÿ°', 'An-Nisa', 'The Women', 'Medinan', 176],
      [5, 'ÿßŸÑŸÖÿßÿ¶ÿØÿ©', 'Al-Ma\'idah', 'The Table Spread', 'Medinan', 120],
      [6, 'ÿßŸÑÿ£ŸÜÿπÿßŸÖ', 'Al-An\'am', 'The Cattle', 'Meccan', 165],
      [7, 'ÿßŸÑÿ£ÿπÿ±ÿßŸÅ', 'Al-A\'raf', 'The Heights', 'Meccan', 206],
      [8, 'ÿßŸÑÿ£ŸÜŸÅÿßŸÑ', 'Al-Anfal', 'The Spoils of War', 'Medinan', 75],
      [9, 'ÿßŸÑÿ™Ÿàÿ®ÿ©', 'At-Tawbah', 'The Repentance', 'Medinan', 129],
      [10, 'ŸäŸàŸÜÿ≥', 'Yunus', 'Jonah', 'Meccan', 109],
      [11, 'ŸáŸàÿØ', 'Hud', 'Hud', 'Meccan', 123],
      [12, 'ŸäŸàÿ≥ŸÅ', 'Yusuf', 'Joseph', 'Meccan', 111],
      [13, 'ÿßŸÑÿ±ÿπÿØ', 'Ar-Ra\'d', 'The Thunder', 'Medinan', 43],
      [14, 'ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ', 'Ibrahim', 'Abraham', 'Meccan', 52],
      [15, 'ÿßŸÑÿ≠ÿ¨ÿ±', 'Al-Hijr', 'The Rocky Tract', 'Meccan', 99],
      [16, 'ÿßŸÑŸÜÿ≠ŸÑ', 'An-Nahl', 'The Bee', 'Meccan', 128],
      [17, 'ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°', 'Al-Isra', 'The Night Journey', 'Meccan', 111],
      [18, 'ÿßŸÑŸÉŸáŸÅ', 'Al-Kahf', 'The Cave', 'Meccan', 110],
      [19, 'ŸÖÿ±ŸäŸÖ', 'Maryam', 'Mary', 'Meccan', 98],
      [20, 'ÿ∑Ÿá', 'Taha', 'Ta-Ha', 'Meccan', 135],
      [21, 'ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°', 'Al-Anbya', 'The Prophets', 'Meccan', 112],
      [22, 'ÿßŸÑÿ≠ÿ¨', 'Al-Hajj', 'The Pilgrimage', 'Medinan', 78],
      [23, 'ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ', 'Al-Mu\'minun', 'The Believers', 'Meccan', 118],
      [24, 'ÿßŸÑŸÜŸàÿ±', 'An-Nur', 'The Light', 'Medinan', 64],
      [25, 'ÿßŸÑŸÅÿ±ŸÇÿßŸÜ', 'Al-Furqan', 'The Criterion', 'Meccan', 77],
      [26, 'ÿßŸÑÿ¥ÿπÿ±ÿßÿ°', 'Ash-Shu\'ara', 'The Poets', 'Meccan', 227],
      [27, 'ÿßŸÑŸÜŸÖŸÑ', 'An-Naml', 'The Ant', 'Meccan', 93],
      [28, 'ÿßŸÑŸÇÿµÿµ', 'Al-Qasas', 'The Stories', 'Meccan', 88],
      [29, 'ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™', 'Al-\'Ankabut', 'The Spider', 'Meccan', 69],
      [30, 'ÿßŸÑÿ±ŸàŸÖ', 'Ar-Rum', 'The Romans', 'Meccan', 60],
      [31, 'ŸÑŸÇŸÖÿßŸÜ', 'Luqman', 'Luqman', 'Meccan', 34],
      [32, 'ÿßŸÑÿ≥ÿ¨ÿØÿ©', 'As-Sajdah', 'The Prostration', 'Meccan', 30],
      [33, 'ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®', 'Al-Ahzab', 'The Clans', 'Medinan', 73],
      [34, 'ÿ≥ÿ®ÿ£', 'Saba', 'Sheba', 'Meccan', 54],
      [35, 'ŸÅÿßÿ∑ÿ±', 'Fatir', 'Originator', 'Meccan', 45],
      [36, 'Ÿäÿ≥', 'Ya-Sin', 'Ya Sin', 'Meccan', 83],
      [37, 'ÿßŸÑÿµÿßŸÅÿßÿ™', 'As-Saffat', 'Those who set the Ranks', 'Meccan', 182],
      [38, 'ÿµ', 'Sad', 'The Letter "Sad"', 'Meccan', 88],
      [39, 'ÿßŸÑÿ≤ŸÖÿ±', 'Az-Zumar', 'The Troops', 'Meccan', 75],
      [40, 'ÿ∫ÿßŸÅÿ±', 'Ghafir', 'The Forgiver', 'Meccan', 85],
      [41, 'ŸÅÿµŸÑÿ™', 'Fussilat', 'Explained in Detail', 'Meccan', 54],
      [42, 'ÿßŸÑÿ¥Ÿàÿ±Ÿâ', 'Ash-Shuraa', 'The Consultation', 'Meccan', 53],
      [43, 'ÿßŸÑÿ≤ÿÆÿ±ŸÅ', 'Az-Zukhruf', 'The Ornaments of Gold', 'Meccan', 89],
      [44, 'ÿßŸÑÿØÿÆÿßŸÜ', 'Ad-Dukhan', 'The Smoke', 'Meccan', 59],
      [45, 'ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©', 'Al-Jathiyah', 'The Crouching', 'Meccan', 37],
      [46, 'ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ', 'Al-Ahqaf', 'The Wind-Curved Sandhills', 'Meccan', 35],
      [47, 'ŸÖÿ≠ŸÖÿØ', 'Muhammad', 'Muhammad', 'Medinan', 38],
      [48, 'ÿßŸÑŸÅÿ™ÿ≠', 'Al-Fath', 'The Victory', 'Medinan', 29],
      [49, 'ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™', 'Al-Hujurat', 'The Rooms', 'Medinan', 18],
      [50, 'ŸÇ', 'Qaf', 'The Letter "Qaf"', 'Meccan', 45],
      [51, 'ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™', 'Adh-Dhariyat', 'The Winnowing Winds', 'Meccan', 60],
      [52, 'ÿßŸÑÿ∑Ÿàÿ±', 'At-Tur', 'The Mount', 'Meccan', 49],
      [53, 'ÿßŸÑŸÜÿ¨ŸÖ', 'An-Najm', 'The Star', 'Meccan', 62],
      [54, 'ÿßŸÑŸÇŸÖÿ±', 'Al-Qamar', 'The Moon', 'Meccan', 55],
      [55, 'ÿßŸÑÿ±ÿ≠ŸÖŸÜ', 'Ar-Rahman', 'The Beneficent', 'Medinan', 78],
      [56, 'ÿßŸÑŸàÿßŸÇÿπÿ©', 'Al-Waqi\'ah', 'The Inevitable', 'Meccan', 96],
      [57, 'ÿßŸÑÿ≠ÿØŸäÿØ', 'Al-Hadid', 'The Iron', 'Medinan', 29],
      [58, 'ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©', 'Al-Mujadila', 'The Pleading Woman', 'Medinan', 22],
      [59, 'ÿßŸÑÿ≠ÿ¥ÿ±', 'Al-Hashr', 'The Exile', 'Medinan', 24],
      [60, 'ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©', 'Al-Mumtahanah', 'She that is to be examined', 'Medinan', 13],
      [61, 'ÿßŸÑÿµŸÅ', 'As-Saff', 'The Ranks', 'Medinan', 14],
      [62, 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'Al-Jumu\'ah', 'The Congregation, Friday', 'Medinan', 11],
      [63, 'ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ', 'Al-Munafiqun', 'The Hypocrites', 'Medinan', 11],
      [64, 'ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ', 'At-Taghabun', 'The Mutual Disillusion', 'Medinan', 18],
      [65, 'ÿßŸÑÿ∑ŸÑÿßŸÇ', 'At-Talaq', 'The Divorce', 'Medinan', 12],
      [66, 'ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ', 'At-Tahrim', 'The Prohibition', 'Medinan', 12],
      [67, 'ÿßŸÑŸÖŸÑŸÉ', 'Al-Mulk', 'The Sovereignty', 'Meccan', 30],
      [68, 'ÿßŸÑŸÇŸÑŸÖ', 'Al-Qalam', 'The Pen', 'Meccan', 52],
      [69, 'ÿßŸÑÿ≠ÿßŸÇÿ©', 'Al-Haqqah', 'The Reality', 'Meccan', 52],
      [70, 'ÿßŸÑŸÖÿπÿßÿ±ÿ¨', 'Al-Ma\'arij', 'The Ascending Stairways', 'Meccan', 44],
      [71, 'ŸÜŸàÿ≠', 'Nuh', 'Noah', 'Meccan', 28],
      [72, 'ÿßŸÑÿ¨ŸÜ', 'Al-Jinn', 'The Jinn', 'Meccan', 28],
      [73, 'ÿßŸÑŸÖÿ≤ŸÖŸÑ', 'Al-Muzzammil', 'The Enshrouded One', 'Meccan', 20],
      [74, 'ÿßŸÑŸÖÿØÿ´ÿ±', 'Al-Muddaththir', 'The Cloaked One', 'Meccan', 56],
      [75, 'ÿßŸÑŸÇŸäÿßŸÖÿ©', 'Al-Qiyamah', 'The Resurrection', 'Meccan', 40],
      [76, 'ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ', 'Al-Insan', 'The Man', 'Medinan', 31],
      [77, 'ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™', 'Al-Mursalat', 'The Emissaries', 'Meccan', 50],
      [78, 'ÿßŸÑŸÜÿ®ÿ£', 'An-Naba', 'The Tidings', 'Meccan', 40],
      [79, 'ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™', 'An-Nazi\'at', 'Those who drag forth', 'Meccan', 46],
      [80, 'ÿπÿ®ÿ≥', 'Abasa', 'He Frowned', 'Meccan', 42],
      [81, 'ÿßŸÑÿ™ŸÉŸàŸäÿ±', 'At-Takwir', 'The Overthrowing', 'Meccan', 29],
      [82, 'ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±', 'Al-Infitar', 'The Cleaving', 'Meccan', 19],
      [83, 'ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ', 'Al-Mutaffifin', 'The Defrauding', 'Meccan', 36],
      [84, 'ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ', 'Al-Inshiqaq', 'The Splitting Open', 'Meccan', 25],
      [85, 'ÿßŸÑÿ®ÿ±Ÿàÿ¨', 'Al-Buruj', 'The Mansions of the Stars', 'Meccan', 22],
      [86, 'ÿßŸÑÿ∑ÿßÿ±ŸÇ', 'At-Tariq', 'The Morning Star', 'Meccan', 17],
      [87, 'ÿßŸÑÿ£ÿπŸÑŸâ', 'Al-A\'la', 'The Most High', 'Meccan', 19],
      [88, 'ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©', 'Al-Ghashiyah', 'The Overwhelming', 'Meccan', 26],
      [89, 'ÿßŸÑŸÅÿ¨ÿ±', 'Al-Fajr', 'The Dawn', 'Meccan', 30],
      [90, 'ÿßŸÑÿ®ŸÑÿØ', 'Al-Balad', 'The City', 'Meccan', 20],
      [91, 'ÿßŸÑÿ¥ŸÖÿ≥', 'Ash-Shams', 'The Sun', 'Meccan', 15],
      [92, 'ÿßŸÑŸÑŸäŸÑ', 'Al-Layl', 'The Night', 'Meccan', 21],
      [93, 'ÿßŸÑÿ∂ÿ≠Ÿâ', 'Ad-Duhaa', 'The Morning Hours', 'Meccan', 11],
      [94, 'ÿßŸÑÿ¥ÿ±ÿ≠', 'Ash-Sharh', 'The Relief', 'Meccan', 8],
      [95, 'ÿßŸÑÿ™ŸäŸÜ', 'At-Tin', 'The Fig', 'Meccan', 8],
      [96, 'ÿßŸÑÿπŸÑŸÇ', 'Al-\'Alaq', 'The Clot', 'Meccan', 19],
      [97, 'ÿßŸÑŸÇÿØÿ±', 'Al-Qadr', 'The Power', 'Meccan', 5],
      [98, 'ÿßŸÑÿ®ŸäŸÜÿ©', 'Al-Bayyinah', 'The Clear Proof', 'Medinan', 8],
      [99, 'ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©', 'Az-Zalzalah', 'The Earthquake', 'Medinan', 8],
      [100, 'ÿßŸÑÿπÿßÿØŸäÿßÿ™', 'Al-\'Adiyat', 'The Courser', 'Meccan', 11],
      [101, 'ÿßŸÑŸÇÿßÿ±ÿπÿ©', 'Al-Qari\'ah', 'The Calamity', 'Meccan', 11],
      [102, 'ÿßŸÑÿ™ŸÉÿßÿ´ÿ±', 'At-Takathur', 'The Rivalry in world increase', 'Meccan', 8],
      [103, 'ÿßŸÑÿπÿµÿ±', 'Al-\'Asr', 'The Declining Day', 'Meccan', 3],
      [104, 'ÿßŸÑŸáŸÖÿ≤ÿ©', 'Al-Humazah', 'The Traducer', 'Meccan', 9],
      [105, 'ÿßŸÑŸÅŸäŸÑ', 'Al-Fil', 'The Elephant', 'Meccan', 5],
      [106, 'ŸÇÿ±Ÿäÿ¥', 'Quraysh', 'Quraysh', 'Meccan', 4],
      [107, 'ÿßŸÑŸÖÿßÿπŸàŸÜ', 'Al-Ma\'un', 'The Small kindnesses', 'Meccan', 7],
      [108, 'ÿßŸÑŸÉŸàÿ´ÿ±', 'Al-Kawthar', 'The Abundance', 'Meccan', 3],
      [109, 'ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ', 'Al-Kafirun', 'The Disbelievers', 'Meccan', 6],
      [110, 'ÿßŸÑŸÜÿµÿ±', 'An-Nasr', 'The Divine Support', 'Medinan', 3],
      [111, 'ÿßŸÑŸÖÿ≥ÿØ', 'Al-Masad', 'The Palm Fiber', 'Meccan', 5],
      [112, 'ÿßŸÑÿ•ÿÆŸÑÿßÿµ', 'Al-Ikhlas', 'The Sincerity', 'Meccan', 4],
      [113, 'ÿßŸÑŸÅŸÑŸÇ', 'Al-Falaq', 'The Daybreak', 'Meccan', 5],
      [114, 'ÿßŸÑŸÜÿßÿ≥', 'An-Nas', 'Mankind', 'Meccan', 6],
    ];

    int ayahNumber = 1;
    
    await db.transaction((txn) async {
      // Ins√©rer toutes les sourates
      for (final surahData in surahsData) {
        await txn.insert(_surahsTable, {
          'number': surahData[0],
          'name': surahData[1],
          'english_name': surahData[2],
          'english_name_translation': surahData[3],
          'revelation_type': surahData[4],
          'number_of_ayahs': surahData[5],
        });
        
        // Cr√©er des ayahs d'exemple pour chaque sourate
        for (int i = 1; i <= (surahData[5] as int); i++) {
          await txn.insert(_ayahsTable, {
            'number': ayahNumber,
            'text': 'ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê - ${surahData[1]} - ÿ¢Ÿäÿ© $i',
            'number_in_surah': i,
            'surah_number': surahData[0],
            'juz': ((ayahNumber - 1) ~/ 200) + 1,
            'manzil': ((ayahNumber - 1) ~/ 900) + 1,
            'page': ((ayahNumber - 1) ~/ 15) + 1,
            'ruku': ((ayahNumber - 1) ~/ 10) + 1,
            'hizb_quarter': ((ayahNumber - 1) ~/ 25) + 1,
            'sajda': 0,
            'translation': 'Traduction fran√ßaise du verset $i de la sourate ${surahData[1]}',
          });
          ayahNumber++;
        }
      }
    });

    print('‚úÖ Donn√©es compl√®tes du Coran cr√©√©es : 114 sourates avec ${ayahNumber - 1} versets');
  }

  /// R√©cup√®re toutes les sourates
  Future<List<Surah>> getAllSurahs() async {
    final db = await database;
    final surahMaps = await db.query(_surahsTable, orderBy: 'number');
    
    final surahs = <Surah>[];
    for (final surahMap in surahMaps) {
      final ayahs = await getAyahsBySurah(surahMap['number'] as int);
      surahs.add(Surah(
        number: surahMap['number'] as int,
        name: surahMap['name'] as String,
        englishName: surahMap['english_name'] as String,
        englishNameTranslation: surahMap['english_name_translation'] as String,
        revelationType: surahMap['revelation_type'] as String,
        numberOfAyahs: surahMap['number_of_ayahs'] as int,
        ayahs: ayahs,
      ));
    }
    
    return surahs;
  }

  /// R√©cup√®re une sourate par son num√©ro
  Future<Surah?> getSurahByNumber(int number) async {
    final db = await database;
    final surahMaps = await db.query(
      _surahsTable,
      where: 'number = ?',
      whereArgs: [number],
    );
    
    if (surahMaps.isEmpty) return null;
    
    final surahMap = surahMaps.first;
    final ayahs = await getAyahsBySurah(number);
    
    return Surah(
      number: surahMap['number'] as int,
      name: surahMap['name'] as String,
      englishName: surahMap['english_name'] as String,
      englishNameTranslation: surahMap['english_name_translation'] as String,
      revelationType: surahMap['revelation_type'] as String,
      numberOfAyahs: surahMap['number_of_ayahs'] as int,
      ayahs: ayahs,
    );
  }

  /// R√©cup√®re les ayahs d'une sourate
  Future<List<Ayah>> getAyahsBySurah(int surahNumber) async {
    final db = await database;
    final ayahMaps = await db.query(
      _ayahsTable,
      where: 'surah_number = ?',
      whereArgs: [surahNumber],
      orderBy: 'number_in_surah',
    );
    
    return ayahMaps.map((map) => Ayah(
      number: map['number'] as int,
      text: map['text'] as String,
      numberInSurah: map['number_in_surah'] as int,
      juz: map['juz'] as int,
      manzil: map['manzil'] as int,
      page: map['page'] as int,
      ruku: map['ruku'] as int,
      hizbQuarter: map['hizb_quarter'] as int,
      sajda: (map['sajda'] as int) == 1,
      translation: map['translation'] as String?,
    )).toList();
  }

  /// R√©cup√®re toutes les donn√©es du Coran
  Future<QuranData> getQuranData() async {
    if (_quranData != null) return _quranData!;
    
    final surahs = await getAllSurahs();
    _quranData = QuranData(surahs: surahs);
    return _quranData!;
  }

  /// Ajouter un verset aux favoris
  Future<void> addToFavorites(int surahNumber, int ayahNumber) async {
    final db = await database;
    await db.insert(
      _favoritesTable,
      {
        'surah_number': surahNumber,
        'ayah_number': ayahNumber,
        'created_at': DateTime.now().toIso8601String(),
      },
      conflictAlgorithm: ConflictAlgorithm.ignore,
    );
  }

  /// Supprimer un verset des favoris
  Future<void> removeFromFavorites(int surahNumber, int ayahNumber) async {
    final db = await database;
    await db.delete(
      _favoritesTable,
      where: 'surah_number = ? AND ayah_number = ?',
      whereArgs: [surahNumber, ayahNumber],
    );
  }

  /// V√©rifier si un verset est dans les favoris
  Future<bool> isFavorite(int surahNumber, int ayahNumber) async {
    final db = await database;
    final result = await db.query(
      _favoritesTable,
      where: 'surah_number = ? AND ayah_number = ?',
      whereArgs: [surahNumber, ayahNumber],
    );
    return result.isNotEmpty;
  }

  /// Ajouter √† l'historique de lecture
  Future<void> addToReadingHistory(int surahNumber, int ayahNumber) async {
    final db = await database;
    await db.insert(_readingHistoryTable, {
      'surah_number': surahNumber,
      'ayah_number': ayahNumber,
      'read_at': DateTime.now().toIso8601String(),
    });
  }

  /// Vider compl√®tement la base de donn√©es et forcer le rechargement
  Future<void> clearAndReload() async {
    final db = await database;
    
    print('üóëÔ∏è Suppression compl√®te de la base de donn√©es...');
    await db.delete(_ayahsTable);
    await db.delete(_surahsTable);
    await db.delete(_favoritesTable);
    await db.delete(_readingHistoryTable);
    
    _quranData = null; // Reset cache
    
    print('üîÑ Rechargement complet depuis l\'API...');
    await _loadQuranDataFromAssets();
  }

  /// Fermer la base de donn√©es
  Future<void> close() async {
    final db = _database;
    if (db != null) {
      await db.close();
      _database = null;
    }
  }
}
